// glider - v0.0.0 - 12/29/2014
// 
// ; Licensed 
(function(a){var b=a.document,c=a.XMLHttpRequest,d=a.setTimeout,e=a.when,$=a.$,f=Object.create({init:function(){return this.objects={},this.promises={},this.paths={script:"src/",data:"data/"},this},set:function(a,b){this.objects[a]=b},get:function(a){return this.objects[a]},fixPath:function(a,b){return this.paths[a]+b},chain:function(a,b){var c=e.defer();return e(a,function(){e.chain(b(),c)}),c},script:function(c){var f,g;if(this.promises[c])return this.promises[c];if(!this.objects[c]){f=$('script[src="'+this.fixPath("script",c)+'"]')[0];if(f)return g=e.defer(),g.resolve(),this.objects[c]=f,this.promises[c]=g.promise,this.promises[c]}return f=a.document.createElement("script"),g=e.defer(),this.objects[c]=f,this.promises[c]=g.promise,f.onload=function(){d(function(){f.promise?f.promise.then(g.resolve.bind(g,f)):g.resolve(f)},0)},f.src=this.fixPath("script",c),b.head.appendChild(f),g.promise},module:function(a,b,c){this.objects[a]||(this.objects[a]=$('script[src="'+this.fixPath("script",a)+'"]')[0]),b?(this.objects[a].promise=b,b.then(c)):c()},text:function(a){if(this.promises[a])return this.promises[a];var b=new c,d=e.defer();return this.promises[a]=d.promise,b.onload=function(){this.objects[a]=b.responseText,d.resolve(b.responseText)}.bind(this),b.onerror=function(){d.reject()},b.open("GET",this.fixPath("data",a)),b.send(),d.promise},data:function(a){if(this.promises[a])return this.promises[a];var b=new c,d=e.defer();return this.promises[a]=d.promise,b.onload=function(){this.objects[a]=b.response,d.resolve(b.response)}.bind(this),b.onerror=function(){d.reject()},b.open("GET",this.fixPath("data",a)),b.responseType="arraybuffer",b.send(),d.promise}}).init();a.load=f})(this),function(a,b){function g(a,c){var d=b.get(c);d.promise?d.promise.then(a.resolve.bind(a,d)):a.resolve(d)}var c=a.setTimeout,d=a.when,e=["engine/init.js","engine/math.js","engine/base.js","engine/object.js","engine/graphics.js","engine/sound.js","engine/physics.js","game/glider.js","game/jet.js","game/main.js"],f;e.forEach(function(a){var e=d.defer();b.set(a,{}),b.promises[a]=e,c(g.bind(null,e,a),0)})}(this,this.load),function(a){var b=a.when,c=a.aqua={};c.type=function(a,b,c,d){c=c||{},d=d||{};var e={},f;e.prototype=Object.create(a.prototype||{},c);for(f in b)e.prototype[f]=b[f];e.prototype.init||(e.prototype.init=function(){});for(f in d)e[f]=d[f];return e.create||(e.create=function(){var a=Object.create(e.prototype);return a.init.apply(a,arguments),a}),e},c.type.Base=c.type({},{}),c.extend=function(a,b){for(var c in b)a[c]=b[c];return a},c.requestAnimFrame=function(){return a.requestAnimationFrame||a.webkitRequestAnimationFrame||a.mozRequestAnimationFrame||a.oRequestAnimationFrame||a.msRequestAnimationFrame||function(b,c){a.setTimeout(b,1e3/60)}}(),c.PriorityItem=c.type(c.type.Base,{init:function(a,b,c,d,e){this.callback=a,this.priority=b||0,this.before=c||!1,this.once=d||!1,this.rate=e||1/60,this.sinceLast=0},call:function(){this.callback.apply(null,arguments)}}),c.PriorityList=c.type(c.type.Base,{init:function(){this.items=[]},add:function(a){var b=0,c=!1;for(;b<this.items.length;b++)if(a.before&&this.items[b].priority>=a.priority||!a.before&&this.items[b].priority>a.priority){this.items.splice(b,0,a),c=!0;break}c||this.items.push(a)},remove:function(a){var b=this.items.indexOf(a);return b!=-1&&this.items.splice(b,1),this},callAll:function(){var a=this.items,b=0,c;for(;b<a.length;b++)c=a[b],c.call.apply(c,arguments),c.once&&(a.splice(b,1),b--)}}),c.Emitter=c.type(c.type.Base,{init:function(){this._events={}},on:function(a,b){this._events[a]||(this._events[a]=[]),this._events[a].indexOf(b)==-1&&this._events[a].push(b)},off:function(a,b){var c=-1;this._events[a]&&(c=this._events[a].indexOf(b))&&this._events[a].splice(c,1)},call:function(a){if(this._events[a]){var b=[],c,d=this._events[a];for(c=1;c<arguments.length;c++)b.push(arguments[c]);for(c=0;c<d.length;c++)d[c].apply(this,b)}}})}(this),function(a){Math.mag=function(a,b){return Math.sqrt(a*a+b*b)},Math.lerp=function(a,b,c){return(b-a)*c+a},Math.clamp=function(a,b,c){return Math.min(Math.max(a,b),c)}}(this),function(a,b){var c=b.type(b.type.Base,{init:function(){this.objects=[],this.tasks=b.PriorityList.create(),this.task(this.call.bind(this,"update")),this.task(this.call.bind(this,"lateUpdate"),c.Priorities.LATE_UPDATE)},add:function(a){a.game=this,this.objects.push(a),a.ongameadd&&a.ongameadd(this),a.call("ongameadd",a,this)},destroy:function(a){this.task(function(){var b=this.objects.indexOf(a);b!=-1&&(a.ongamedestroy&&a.ongamedestroy(this),a.call("ongamedestroy",a,this),a.game=null,this.objects.splice(b,1))}.bind(this),c.Priorities.GARBAGE,!1,!0)},call:function(a){var b=Array.prototype.slice.call(arguments,1),c=this.objects,d=c.length,e,f;for(f=0;f<d;f++)e=c[f],e.call.apply(e,arguments)},task:function(a,c,d,e){var f=b.PriorityItem.create.apply(b.PriorityItem,arguments);return this.tasks.add(f),f},step:function(){this.tasks.callAll(this)},main:function(){},pause:function(){},resume:function(){}},{},{Priorities:{UPDATE:0,LATE_UPDATE:5,RENDER:10,GARBAGE:20}}),d=b.type(b.type.Base,{init:function(){this.components=[]},add:function(a){a.gameObject=this,this.components.push(a),a.onadd(this),this.game&&a.ongameadd(this,this.game)},get:function(a){var b=this.components,c=b.length,d=a.prototype,e,f;for(f=0;f<c;f++){e=b[f];if(d.isPrototypeOf(e))return e}return null},destroy:function(a){function b(){var b=this.components.indexOf(a);b!=-1&&(a.ondestroy(this),this.game&&a.ongamedestroy(this,this.game),a.gameObject=null,this.components.splice(b,1))}this.game?this.game.task(b.bind(this),c.Priorities.GARBAGE,!1,!0):b.call(this)},call:function(a){var b=Array.prototype.slice.call(arguments,1),c=this.components,d=c.length,e,f;for(f=0;f<d;f++)e=c[f],e[a]&&e[a].apply(e,b)}}),e=b.type(b.type.Base,{onadd:function(a){},ongameadd:function(a,b){},ondestroy:function(a){},ongamedestroy:function(a,b){}});b.Game=c,b.GameObject=d,b.Component=e}(this,this.aqua),function(a,b,c){b.module("engine/graphics.js",b.script("engine/object.js"),function(){var d=a.setTimeout,e=a.when,f=a.mat4,g=c.type(c.type.Base,{init:function(a){this.canvas=a,this.drawCalls=c.PriorityList.create(),this.shaders={},this.deferred=e.defer(),this.projection=f.identity(f.create()),this.modelview=f.identity(f.create()),this.matrix=f.create(),e(this.initContext(),this.deferred.resolve.bind(this.deferred)),e(this.deferred,function(){this.last=Date.now(),this.sinceLast=0}.bind(this))},initContext:function(){function b(){this.gl=this.canvas.getContext("experimental-webgl",{antialias:!0}),this.gl?a.resolve(this):d(b.bind(this),0)}var a=e.defer();return b.call(this),a.promise},draw:function(){if(!this.gl)return;var a=Date.now();this.sinceLast+=(a-this.last)/1e3,this.last=a,this.sinceLast>=.05&&this.drawCalls.callAll(this,this.gl);while(this.sinceLast>=.05)this.sinceLast-=.05},addDrawCall:function(a){return this.drawCalls.add(a),this},removeDrawCall:function(a){return this.drawCalls.remove(a),this},addShader:function(a){if(this.shaders[a.name])return this.shaders[a.name].promise;var c=e.defer();return this.shaders[a.name]=a,a.promise=c.promise,e.chain(e.all([this.deferred.promise,b.text(a.path+".vs"),b.text(a.path+".fs")],this._buildProgram.bind(this,a)),c),a.promise},_buildProgram:function(a){var c=this.gl,d=a.program=c.createProgram(),e;a.vertexShader=e=c.createShader(c.VERTEX_SHADER),c.shaderSource(e,b.get(a.path+".vs")),c.compileShader(e),c.attachShader(d,e),a.fragmentShader=e=c.createShader(c.FRAGMENT_SHADER),c.shaderSource(e,b.get(a.path+".fs")),c.compileShader(e),c.attachShader(d,e),c.linkProgram(d)},useShader:function(a){this.gl.useProgram(this.shaders[a].program)},addTexture:function(a){},useTexture:function(a,b){b=b||0}}),h=c.type(c.Component,{ongameadd:function(a,b){this.drawCall=c.PriorityItem.create(this.draw.bind(this)),b.graphics.addDrawCall(this.drawCall)},ongamedestroy:function(a,b){b.graphics.removeDrawCall(this.drawCall)},draw:function(a,b){}});c.graphics=[],c.initGraphics=function(){var a=g.create.apply(null,arguments);return c.graphics.push(a),a},c.Renderer=h})}(this,this.load,this.aqua),function(a,b){var c=a.document,d=a.setInterval,e=a.clearInterval,f=a.when,g=a.aqua,h=g.type(g.type.Base,{init:function(){if(a.webkitAudioContext){this.context=new a.webkitAudioContext;var d=f.defer();f.chain(f.all([f(b.data("music/happy.ogg")).then(this._loadClip.bind(this,"happy")),f(b.data("music/zone.ogg")).then(this._loadClip.bind(this,"zone")),f(b.data("music/approach_danger.ogg")).then(this._loadClip.bind(this,"approach")),f(b.data("music/danger.ogg")).then(this._loadClip.bind(this,"danger"))]),d),d.then(this._playAll.bind(this)).then(null,console.error.bind(console)),this.nodes={main:this.context.createGain()},this.nodes.main.connect(this.context.destination),c.addEventListener("webkitvisibilitychange",this.onvisibilitychange.bind(this)),this.onvisibilitychange()}},onvisibilitychange:function(){if(c.webkitVisibilityState=="visible"){this.visibilityInterval&&e(this.visibilityInterval);var a=0,b=d(function(){this.nodes.main.gain.value=a+=g.game.timing.delta,a>.1&&(this.nodes.main.gain.value=.1,e(b))}.bind(this),50);this.visibilityInterval=b}else this.nodes.main.gain.value=0,this.visibilityInterval&&e(this.visibilityInterval)},_loadClip:function(a,b){var c=this.nodes[a]={source:this.context.createBufferSource(),gain:this.context.createGain()},d=f.defer();return this.context.decodeAudioData(b,function(a){c.buffer=a,c.source.connect(c.gain),c.gain.connect(this.nodes.main),c.source.buffer=a,d.resolve()}.bind(this),function(a){console.error(a)}),d.promise},_playAll:function(){this.nodes.happy.source.start(0),this.nodes.zone.source.start(0),this.nodes.approach.source.start(0),this.nodes.happy.source.loop=!0,this.nodes.zone.source.loop=!0,this.nodes.approach.source.loop=!0,this.nodes.happy.gain.value=0,this.nodes.zone.gain.value=0,this.nodes.approach.gain.value=0}});g.SoundContext=h}(this,this.load),function(a,b){var c=a.ArrayBuffer,d=a.Float32Array,e=a.Uint8Array,f=a.when,g=a.aqua,h=a.vec3;b.module("engine/physics.js",f.all([b.script("engine/object.js"),b.script("engine/graphics.js"),b.script("engine/math.js")]),function(){function k(a,b,c){return b+c*a.cellsWide}var a=1.999,b=.999,f=.001,i=g.type(g.Emitter,{init:function(a,b,c){Object.getPrototypeOf(Object.getPrototypeOf(this)).init.apply(this),this.position=a.slice(),this.lastPosition=a.slice(),this.oldPosition=a.slice(),this.acceleration=[0,0,0],this.temporaryPosition=a.slice(),this.radius=b,this.mass=c*b*b,this.mask=i.Masks.LIQUID,this.collisionMask=i.Masks.ALL,this.friction=f},integrate:function(c){!this.isStatic&&!this.isTrigger&&(h.set(this.position,this.temporaryPosition),h.add(h.subtract(h.scale(this.position,a,this.position),h.scale(this.lastPosition,b,this.lastPosition),this.position),h.scale(this.acceleration,c*c,this.acceleration),this.position),h.set(this.temporaryPosition,this.lastPosition)),this.x=this.position[0],this.y=this.position[1],this.lx=this.lastPosition[0],this.ly=this.lastPosition[1];for(var d=0;d<3;d++)this.acceleration[d]=0},test:function(a,b){if(this.isStatic&&a.isStatic)return!1;var c=this.x,d=this.y,e=this.radius,f=a.x,g=a.y,h=a.radius,i=b,j;j=Math.pow(c-f,2)+Math.pow(d-g,2);if(j<Math.pow(e+h,2)){i.ingression=j=Math.mag(c-f,d-g),i.weight=e+h,i.distance=i.ingression-i.weight;var k=c-f,l=d-g,m=j,n=(m-e)/m,o=h/m;return i.px=f+Math.lerp(0,k,n),i.py=g+Math.lerp(0,l,n),i.qx=f+Math.lerp(0,k,o),i.qy=g+Math.lerp(0,l,o),!0}return!1},solve:function(a,b){var c=this,d=a,e=b,f=(e.qx-e.px)*.5,g=(e.qy-e.py)*.5,h=c.mass,i=d.mass,j=h+i,k=i/j,l=h/j,m=c.lx-c.x,n=c.ly-c.y,o=Math.mag(m,n),p=d.lx-d.x,q=d.ly-d.y,r=Math.mag(p,q),s=Math.abs(e.distance)*(o+r>50?.1:c.friction*d.friction);o+r<30&&(f*=.1,g*=.1),m=m/o*(o-s),n=n/o*(o-s),p=p/r*(r-s),q=q/r*(r-s),c.isStatic?(k=0,l=1):d.isStatic&&(k=1,l=0),c.isTrigger?c.call("collision",d,e):d.isTrigger?d.call("collision",c,e):(c.lastPosition[0]=c.lx=c.position[0]+m,c.lastPosition[1]=c.ly=c.position[1]+n,c.position[0]+=f*k,c.x=c.position[0],c.position[1]+=g*k,c.y=c.position[1],d.lastPosition[0]=d.lx=d.position[0]+p,d.lastPosition[1]=d.ly=d.position[1]+q,d.position[0]-=f*l,d.x=d.position[0],d.position[1]-=g*l,d.y=d.position[1])}},{isStatic:{get:function(){return!!(this.mask&i.Masks.STATIC)},set:function(a){a?this.mask|=i.Masks.STATIC:this.mask=(this.mask|i.Masks.STATIC)^i.Masks.STATIC}},isTrigger:{get:function(){return!!(this.mask&i.Masks.TRIGGER)},set:function(a){a?this.mask|=i.Masks.TRIGGER:this.mask=(this.mask|i.Masks.TRIGGER)^i.Masks.TRIGGER}}},{Masks:{LIQUID:1,SOLID:2,GAS:4,STATIC:8,TRIGGER:16,ALL:-1}}),j=g.type(g.type.Base,{init:function(a,b,c,d){this.top=a,this.right=b,this.bottom=c,this.left=d,this.width=b-d,this.height=a-c},contains:function(a){return a[0]<this.right&&a[0]>this.left&&a[1]<this.top&&a[1]>this.bottom},copy:function(){return j.create(this.top,this.right,this.bottom,this.left)},translate:function(a,b){this.top+=b,this.bottom+=b,this.left+=a,this.right+=a}}),l=g.type(g.type.Base,{init:function(a,b){this.hash={},this.arrayHash=[],this.box=a,this.newBox=b.copy(),this.lastBox=b.copy(),this.cellsWide=Math.ceil(b.width/a.width),this.cellsTall=Math.ceil(b.height/a.height)},each:function(a){var b;for(b=0;b<this.arrayHash.length;b++)this.arrayHash[b]&&a(this.arrayHash[b],Math.floor(b/this.cellsWide),b%this.cellsWide)},cell:function(a,b){return this.arrayHash[k(this,Math.floor((a-this.lastBox.left)/this.box.width),Math.floor((b-this.lastBox.bottom)/this.box.height))]},add:function(a){var b=a.position[0],c=a.position[1],d=a.radius,e=this.box.width,f=this.box.height,g=this.cellsWide,i=this.cellsTall,j=this.newBox,l,m;for(l=Math.floor((b-d-j.left)/e);l>=0&&l<g&&l<Math.floor((b+d-j.left)/e+1);l++)for(m=Math.floor((c-d-j.bottom)/f);m>=0&&m<i&&m<Math.floor((c+d-j.bottom)/f+1);m++){var n=k(this,l,m),o=this.arrayHash[n];o||(this.arrayHash[n]=o=[]),o.push(a)}h.set(a.position,a.oldPosition)},remove:function(a){var b=a.oldPosition[0],c=a.oldPosition[1],d=a.radius,e=this.box.width,f=this.box.height,g=this.cellsWide,h=this.cellsTall,i=this.lastBox,j,l;for(j=Math.floor((b-d-i.left)/e);j>=0&&j<g&&j<Math.floor((b+d-i.left)/e+1);j++)for(l=Math.floor((c-d-i.bottom)/f);l>=0&&l<h&&l<Math.floor((c+d-i.bottom)/f+1);l++){var m=k(this,j,l),n=this.arrayHash[m];n||(this.arrayHash[m]=n=[]),n.splice(n.indexOf(a),1)}},update:function(a){this.remove(a),this.add(a)}},{},{}),m=g.type(g.GameObject,{init:function(a){Object.getPrototypeOf(Object.getPrototypeOf(this)).init.call(this),this.particles=[],this.collision={},this.box=a,this.gravity=[0,0,0],this.fixedDelta=.05,this.timeToPlay=0,this.hash=l.create(j.create(50,50,0,0),a)},ongameadd:function(a){this.task=a.task(this.update.bind(this),g.Game.Priorities.LATE_UPDATE)},ongamedestroy:function(a){a.tasks.remove(this.task)},addParticle:function(a){this.particles.push(a),this.hash.add(a)},removeParticle:function(a){this.game.task(function(){var b=this.particles.indexOf(a);b&&(this.particles.splice(b,1),this.hash.remove(a))}.bind(this),g.Game.Priorities.GARBAGE,!1,!0)},update:function(){var a=this.fixedDelta;this.game.timing.fixedDelta=a,this.timeToPlay+=this.game.timing.delta,this.timeToPlay>.05&&(this.timeToPlay-=.05,this.game.call("fixedUpdate",this),this.step(a))},step:function(a){var b=this.particles,c=this.collision,d=this.box,e=b.length,f,g,i,j;c.test=0,c.collided=0;for(f=0;f<e;f++)i=b[f],h.add(i.acceleration,this.gravity,i.acceleration),i.integrate(a);var k=0,l=[],m=this.hash;this.hash.each(function(a){k=a.length,l.splice(0,l.length);for(f=0;f<k;f++){i=a[f];for(g=f+1;g<k;g++)j=a[g],i.test(j,c)&&(i.solve(j,c),l.indexOf(i)==-1&&l.push(i),l.indexOf(j)==-1&&l.push(j))}for(f=0;f<l.length;f++)m.update(l[f])}),this.box.translate(1,0),this.hash.newBox=this.box.copy();for(f=0;f<e;f++){i=b[f];if(i.position[0]+i.radius<d.left){var n=i.position[0]-i.lastPosition[0];i.position[0]=d.right-i.radius,i.position[1]=d.height*Math.random(),i.lastPosition[1]=i.position[1]}i.position[0]+i.radius>d.right&&(i.position[0]=d.right-i.radius),i.position[1]+i.radius>d.top&&(i.position[1]=d.top-i.radius),i.position[1]-i.radius<d.bottom&&(i.position[1]=d.bottom+i.radius),this.hash.update(i)}this.hash.lastBox=this.box.copy()}}),n=g.type(g.Renderer,{onadd:function(a){this.world=a},draw:function(a,b){this.shader||(a.addShader({name:"a_color",path:"shaders/a_color"}),this.shader=a.shaders.a_color);if(!this.shader.program)return;this.buffer||(this.buffer=b.createBuffer(),b.bindBuffer(b.ARRAY_BUFFER,this.buffer),b.bufferData(b.ARRAY_BUFFER,this.world.particles.length*6*16,b.DYNAMIC_DRAW));var f=new c(this.world.particles.length*6*16),g=new d(f),h=new e(f),i=this.world.particles,j,k=this.world.fixedDelta,l=this.shader,m=this.buffer,n=i.length,o,p,q=0,r,s,t,u,v,w,x,y,z,A,B;l.matrixLocation||(l.matrixLocation=b.getUniformLocation(l.program,"modelview_projection"),l.positionLocation=b.getAttribLocation(l.program,"a_position"),l.colorLocation=b.getAttribLocation(l.program,"a_color"),b.enableVertexAttribArray(l.positionLocation),b.enableVertexAttribArray(l.colorLocation));for(o=0;o<n;o++){j=i[o],s=j.x,t=j.y,u=j.radius;if(!j.isTrigger)for(p=0;p<24;p++)p%4===0?g[q+p]=s+(p%8>3?1:-1)*u:p%4==1&&(g[q+p]=t+((p-1)/4==2||(p-1)/4==4||(p-1)/4==5?1:-1)*u);q+=24}q=0;for(o=0;o<n;o++){j=i[o];if(j.isTrigger)continue;s=j.x,t=j.y,v=j.lx,w=j.ly,x=Math.mag(s-v,t-w)*2,y=Math.clamp(x/50*255,0,218),z=Math.clamp(x/50*255,0,43),A=Math.clamp(x/50*255,0,58),B=Math.clamp(x/50*255,0,255);for(p=0;p<96;p+=16)h[q+p+12]=y,h[q+p+13]=z,h[q+p+14]=A,h[q+p+15]=B;q+=96}b.enable(b.BLEND),a.useShader("a_color"),b.bindBuffer(b.ARRAY_BUFFER,m),b.bufferData(b.ARRAY_BUFFER,f,b.DYNAMIC_DRAW),b.uniformMatrix4fv(l.matrixLocation,!1,a.projection),b.vertexAttribPointer(l.positionLocation,2,b.FLOAT,!1,16,0),b.vertexAttribPointer(l.colorLocation,4,b.UNSIGNED_BYTE,!0,16,12),b.drawArrays(b.TRIANGLES,0,f.byteLength/16)}});g.Particle=i,g.World=m,g.World.Renderer=n,g.Box=j})}(this,this.load),function(a,b){var c=a.when;b.module("engine/init.js",b.chain(b.script("engine/base.js"),function(){return c.all([b.script("engine/object.js"),b.script("engine/graphics.js"),b.script("engine/sound.js"),b.script("engine/physics.js")])}),function(){})}(this,this.load),function(a,b){a.glider={};var c=a.when;b.module("game/main.js",b.chain(b.script("engine/init.js"),function(){return c.all([b.script("game/glider.js"),b.script("game/jet.js")])}),function(){function g(){d.requestAnimFrame.call(null,g),d.game.step()}var $=a.$,b=a.when,c=a.mat4,d=a.aqua,e=a.glider;d.game=d.Game.create(),d.game.graphics=d.initGraphics($("canvas")[0]),d.game.graphics.addShader({name:"basic",path:"shaders/basic"}),d.game.task(d.game.call.bind(d.game,"render"),d.Game.Priorities.RENDER),d.game.task(d.game.graphics.draw.bind(d.game.graphics),d.Game.Priorities.RENDER),d.game.timing={delta:0,last:Date.now()},d.game.task(function(){var a=Date.now();d.game.timing.delta=Math.clamp((a-d.game.timing.last)/1e3,0,.3),d.game.timing.last=a},-10),d.game.world=d.World.create(d.Box.create(400,640,0,0)),d.game.add(d.game.world),d.game.world.add(d.World.Renderer.create());for(var f=0;f<500;f++)d.game.world.addParticle(d.Particle.create([640*(f/500),Math.random()*480,0],15+Math.random()*3,1));d.game.world.add(e.Jet.create()),d.game.graphics.addDrawCall(d.PriorityItem.create(function(a,b){b.clearColor(0,22/255,55/255,1),a.useShader("basic"),b.enable(b.BLEND),b.blendFunc(b.SRC_ALPHA,b.DST_ALPHA)},-1e3,!1,!0)),d.game.graphics.addDrawCall(d.PriorityItem.create(function(b,e){var f=a.innerWidth,g=a.innerHeight;b.canvas.width=f,b.canvas.height=g,e.viewport(0,0,f,g),c.ortho(d.game.world.box.left,d.game.world.box.width+d.game.world.box.left,0,d.game.world.box.height,0,1e3,b.projection),e.clear(e.COLOR_BUFFER_BIT),b.useShader("basic")},-1e3)),d.game.sound=d.SoundContext.create(),d.game.score=e.GliderScore.create(),d.game.add(function(){var a=d.GameObject.create();return a.add(d.game.score),a}()),d.game.player=e.makeGlider(),d.game.add(d.game.player),g()})}(this,this.load),function(a,b){b.module("game/glider.js",null,function(){function o(a){while(a>Math.PI)a-=Math.PI*2;while(a<Math.PI)a+=Math.PI*2;return a}var c=a.document,d=a.localStorage,e=a.setTimeout,f=a.setInterval,g=a.clearInterval,h=a.ArrayBuffer,i=a.Float32Array,j=a.atob,k=a.vec3,l=a.when,$=a.$,m=a.aqua,n=a.glider,p=m.type(m.Component,{init:function(a){var b;this.inputMap=a,this.state={};for(b in a)this.state[a[b]]={pressed:!1}},onadd:function(){a.addEventListener("keydown",this._keydown=this.keydown.bind(this)),a.addEventListener("keyup",this._keyup=this.keyup.bind(this))},ondestroy:function(){a.removeEventListener("keydown",this._keydown),a.removeEventListener("keyup",this._keyup)},get:function(a){return this.state[a].pressed},getPressTime:function(a){return this.state[a].pressed&&Date.now()-this.state[a].start},keydown:function(a){var b=this.state[this.inputMap[a.keyCode]];if(!b)return;b.pressed=!0,b.start||(b.start=Date.now())},keyup:function(a){var b=this.state[this.inputMap[a.keyCode]];if(!b)return;b.pressed=!1,delete b.start}}),q=m.type(m.Component,{init:function(a){this.inputMap=a.inputMap||a},ongameadd:function(b,c){this._keydown=this.keydown.bind(this),a.addEventListener("keydown",this._keydown),this.game=c},keydown:function(b){this.inputMap[b.keyCode]=="up"&&(a.removeEventListener("keydown",this._keydown),this.game.add(n.makeGlider()),this.game.destroy(this.gameObject))}}),r=m.type(m.Component,{init:function(){this.x=400,this.y=180,this.vx=0,this.vy=0,this.ax=0,this.ay=0,this.angle=0,this.radius=25,this.score=0,this.particle=m.Particle.create([this.x,this.y,0],this.radius,1),this.particle.isTrigger=!0,this.particle.on("collision",this.oncollision.bind(this)),this.playing=!1},onadd:function(a){this.input=a.get(p)},ondestroy:function(){this.input=null},ongameadd:function(a,b){b.world.addParticle(this.particle),this.world=b.world,this.sound=b.sound,this.x+=b.world.box.left},ongamedestroy:function(a,b){b.world.removeParticle(this.particle),b.score&&b.score.setMove(null),m.game.sound&&(m.game.sound.nodes.happy.gain.value=1,m.game.sound.nodes.zone.gain.value=0,m.game.sound.nodes.approach.gain.value=0)},oncollision:function(a,b){if(!this.playing)return;var c=m.game.timing.fixedDelta,d=a.lastPosition[0]-a.position[0],e=a.lastPosition[1]-a.position[1],f=Math.sqrt(d*d+e*e),g=Math.atan2(e,d);if(isNaN(d)||isNaN(e))return;while(g>Math.PI)g-=Math.PI*2;while(g<-Math.PI)g+=Math.PI*2;var h=f,i=h*Math.cos(g+Math.PI-this.angle-Math.PI/2)*(Math.abs(g-this.angle)<Math.PI/2?1:0),j=Math.cos(this.angle+Math.PI/2)*i,k=Math.sin(this.angle+Math.PI/2)*i*2;this.ax+=Math.clamp(j,-10,1e3),this.ay+=k},fixedUpdate:function(){if(!this.playing&&this.input.get("up"))this.playing=!0,this.gameObject.game.score&&this.gameObject.game.score.setMove(this),this.heatmapTime=Date.now();else if(!this.playing){this.x=this.world.box.left+this.world.box.width/8*5;return}var a=m.game.timing.fixedDelta,b=Math.sqrt(this.vx*this.vx+this.vy*this.vy),c=Math.atan2(this.vy,this.vx);while(c>Math.PI)c-=Math.PI*2;while(c<-Math.PI)c+=Math.PI*2;this.ay-=16;var d=b*2,e=d*Math.cos(c+Math.PI-this.angle-Math.PI/2)*(Math.abs(c-this.angle)<Math.PI/2?1:0),f=Math.cos(this.angle+Math.PI/2)*e,g=Math.sin(this.angle+Math.PI/2)*e;this.ax+=f,this.ay+=g,this.input.get("up")&&(this.angle+=Math.PI*a,this.x<this.world.box.left+this.world.box.width/3&&(this.ax+=Math.cos(this.angle)*50,this.ay+=Math.sin(this.angle)*50),this.y<this.world.box.bottom+this.world.box.height/8&&(this.ax+=Math.cos(this.angle)*50,this.ay+=Math.sin(this.angle)*200)),this.vx+=this.ax/2*a,this.x+=this.vx*a,this.vx+=this.ax/2*a,this.vy+=this.ay/2*a,this.y+=this.vy*a,this.vy+=this.ay/2*a,k.set([this.x,this.y,0],this.particle.position),this.angle-=Math.PI*.2*a,this.angle>Math.PI&&(this.canScoreBackflip=!0);while(this.angle>Math.PI)this.angle-=Math.PI*2;while(this.angle<-Math.PI)this.angle+=Math.PI*2;this.angle>-Math.PI/4&&this.canScoreBackflip&&m.game.score&&(this.canScoreBackflip=!1,m.game.score.addTrick("Backflip",5e4)),this.ax=0,this.ay=0;var h=this.fadeHappy=Math.clamp((this.x-this.world.box.left-this.world.box.width/2)/40,0,1),i=this.fadeApproach=Math.clamp((this.x-240+this.y/8-this.world.box.left)/(this.world.box.width/6),0,1);this.fadeApproach===0&&(this.inDanger=!0),this.fadeApproach==1&&this.inDanger&&(this.inDanger=!1,m.game.score&&m.game.score.addTrick("Back for More",5e4)),this.sound.nodes&&(this.sound.nodes.happy&&(this.sound.nodes.happy.gain.value=Math.clamp(Math.lerp(0,1,h),0,1)),this.sound.nodes.zone&&(this.sound.nodes.zone.gain.value=Math.clamp(Math.lerp(0,1,Math.lerp(1-h,0,1-Math.sqrt(i))),0,1)),this.sound.nodes.approach&&(this.sound.nodes.approach.gain.value=Math.clamp(Math.lerp(1,0,i),0,1))),this.world.box.contains([this.x,this.y])&&i>0&&(this.score+=h*this.gameObject.game.timing.delta*1e3,this.score+=(1-h)*this.gameObject.game.timing.delta*1e4),Date.now()-this.heatmapTime>1e4&&(this.heatmapTime=Date.now());if(!(this.world.box.contains([this.x+this.radius,this.y+this.radius])||this.world.box.contains([this.x+this.radius,this.y-this.radius])||this.world.box.contains([this.x-this.radius,this.y+this.radius])||this.world.box.contains([this.x-this.radius,this.y-this.radius]))){m.game.score&&(this.world.box.bottom>this.y?m.game.score.addTrick("The World is Flat",1e4):this.world.box.top<this.y?m.game.score.addTrick("To The Sky",2e5):this.world.box.right<this.x?m.game.score.addTrick("Exit Stage Right",1e6):this.world.box.left>this.x&&m.game.score.addTrick("Exit Stage Left",1e5)),this.gameObject.game.destroy(this.gameObject);var j=m.GameObject.create();j.add(q.create(this.gameObject.get(p))),this.gameObject.game.add(j)}}}),s=m.type(m.Component,{init:function(){this.score=0,this.playerName=d&&d.playerName||"Player",this.bestScore=d&&d.best&&parseInt(JSON.parse(d.best||"{}")[this.playerName],10)||0,this.zoneTime=0,this.zoneDiv=null,this.tricks=[],l(b.text("locale/en/tricks.json"),function(a){this.titles=JSON.parse(a)}.bind(this)),$(function(){this.modes={all:$("#scoremode div"),nameDiv:$("#scoremode div.name"),bestDiv:$("#scoremode div.best"),currentDiv:$("#scoremode div.current"),worldBestDiv:$("#scoremode div.world")},this.modes.nameDiv.click(this.onmodeclick.bind(this,{div:this.modes.nameDiv,setter:function(a){},init:function(a){a.text(this.playerName),a.attr("contenteditable",!0),a.attr("spellcheck",!1),a.text()=="Player"&&(a.focus(),c.execCommand("selectAll")),a.on("keydown",function(b){if(b.keyCode==91||b.keyCode==13)b.preventDefault(),a.blur()}),a.blur(function(){a.text().trim()===""&&a.text("Player"),d.playerName=a.text(),d.playerName!=this.playerName&&(this.playerName=d.playerName,this.bestScore=JSON.parse(d.best||"{}")[this.playerName]||0)}.bind(this))}})),this.modes.bestDiv.click(this.onmodeclick.bind(this,{div:this.modes.bestDiv,init:function(a){a.find(".value").text(parseInt(this.bestScore,10))}})),this.modes.currentDiv.click(this.onmodeclick.bind(this,{div:this.modes.currentDiv,setter:function(a){a.text(parseInt(this.score,10))},init:function(a){}})),this.modes.worldBestDiv.click(this.onmodeclick.bind(this,{div:this.modes.worldBestDiv,init:function(a){a.find(".value").text("loading")},setter:null})),this.modes.currentDiv.click()}.bind(this))},onmodeclick:function(a){var b=a.div,c=a.setter||function(){},d=a.init;if(!b.hasClass("off"))return;this.modes.all.addClass("off"),b.removeClass("off");var h=$(".score"),i;h.length===0?i=$('<div class="score"><div class="value">0</div><div class="rank"></div></div>').insertAfter("#scoremode"):(i=$('<div class="score start"><div class="value">0</div><div class="rank"></div></div>').insertAfter(".score"),e(function(){i.removeClass("start")},0)),typeof d=="function"&&d.call(this,i),h.addClass("off"),h[0]&&h[0].interval&&(g(h[0].interval),e(function(){h.remove()},500)),i[0].interval=f(c.bind(this,i.find(".value")),50),c.call(this,i.find(".value"))},showRank:function(a,b,c){var d=$(".score:last .rank"),e=["th","st","nd","rd","th","th","th","th","th","th"];if(typeof c.Success=="undefined")for(var f=0;f<c.length;f++)if(c[f].Name==a&&c[f].Points==b){d.html(c[f].Rank+e[c[f].Rank%10]+"&nbsp;"+c[f].Name);break}},setMove:function(a){this.move=a;if(a==null){var b={Name:this.playerName,Points:parseInt(this.score,10),CustomData:{Name:this.playerName,Points:parseInt(this.score,10),StartTime:this.startTime,EndTime:Date.now()}},c=this.showRank.bind(this,this.playerName,parseInt(this.score,10));this.modes.currentDiv.hasClass("off")&&(c=function(){})}else this.startTime=Date.now();if(a==null&&this.score>this.bestScore&&d){this.bestScore=this.score;var e=JSON.parse(d.best||"{}")||{};e[this.playerName]=this.bestScore,d.best=JSON.stringify(e)}a&&this._clear()},_clear:function(){var a=this.tricks,b=a.length,c;for(c=0;c<b;c++)this.removeTrick(a[c]);this.score=0,this.zoneTime=0,this.zoneTimeAwarded=0,this.zoneDiv=null},getLocale:function(a){return this.titles&&this.titles[a]&&(a=this.titles[a][parseInt(Math.random()*this.titles[a].length-1,10)]),a},addTrick:function(a,b,c){c==null&&(c=2),this.score+=b,this.titles&&this.titles[a]&&(a=this.titles[a][parseInt(Math.random()*this.titles[a].length-1,10)]),a=a.replace(/ /g,"&nbsp;");var d=$('<div class="trick" style="top:'+(32+this.tricks.length*14)+'px;"><div class="value">'+b+'</div><div class="name">'+a+"</div></div>").appendTo(this.stuntDiv);d.find(".name").css("right",-d.find(".name").width()-5),d.time=c,d.points=b,this.tricks.push(d)},removeTrick:function(a){a.removing||(a.removing=!0,a.css("opacity",0),e(function(a){a.remove();var b=this.tricks.indexOf(a);b!=-1&&this.tricks.splice(b,1)}.bind(this,a),500))},ongameadd:function(a,b){this.world=b.world},ongamedestroy:function(){delete this.tricks},addZoneTrick:function(){this.zoneTime=parseInt(this.zoneTime*10,10)/10,this.addTrick(this.zoneTime+"s "+this.getLocale("in the Zone"),this.zoneTime*1e4)},fixedUpdate:function(){var b=this.gameObject.game.timing.fixedDelta,c=this.stuntDiv,d=$(".score:last"),e=$("#scoremode"),f=this.zoneDiv;c||(c=this.stuntDiv=$("#stunts")),this.move&&this.world.box.contains([this.move.x,this.move.y])?(this.move.fadeApproach>0?(this.score+=this.move.fadeHappy*b*1e3,this.score+=(1-this.move.fadeHappy)*b*1e4,this.move.fadeHappy===0?(this.zoneTime+=b,this.zoneTime-this.zoneTimeAwarded>5&&(this.zoneTimeAwarded+=5,this.addTrick(this.zoneTimeAwarded+"s "+this.getLocale("in the Zone"),this.zoneTimeAwarded*1e4))):(this.zoneTime&&this.addZoneTrick(),this.zoneTime=0,this.zoneTimeAwarded=0)):(this.zoneTime&&this.addZoneTrick(),this.zoneTime=0,this.zoneTimeAwarded=0),this.zoneTime>0&&!this.zoneDiv&&(f=this.zoneDiv=$('<div class="trick zone">0s</div>').appendTo(c),this.tricks.splice(0,0,f)),this.zoneTime===0&&this.zoneDiv&&(delete this.zoneDiv,f.time=2,f=null)):this.zoneDiv&&(delete this.zoneDiv,f.time=0,f=null),f&&f.text(parseInt(this.zoneTime*10,10)/10+"s");for(var g=0;g<this.tricks.length;g++){var h=this.tricks[g];h.css("top",32+g*14),h.time!=null&&(h.time-=b,h.time<=0&&this.removeTrick(h))}d&&c.css("left",(a.innerWidth-d.width())/2);var i=e.find("div:eq(1)").css("right",a.innerWidth/2+6);i=e.find("div:eq(0)").css("right",a.innerWidth/2+12+i.width()),i=e.find("div:eq(2)").css("left",a.innerWidth/2+3),e.find("div:eq(3)").css("left",a.innerWidth/2+9+i.width())}}),t=m.type(m.Component,{onadd:function(a){this.move=a.get(r)},ongameadd:function(a,b){this.drawCall=m.PriorityItem.create(this.draw.bind(this)),b.graphics.addDrawCall(this.drawCall)},ongamedestroy:function(a,b){b.graphics.removeDrawCall(this.drawCall)},draw:function(a,b){this.buffer||(this.buffer=b.createBuffer(),this.arrayBuffer=new h(48),this.floatView=new i(this.arrayBuffer));var c=this.floatView,d=this.move.angle,e=this.move.x,f=this.move.y,g=this.move.radius,j=a.shaders.basic;b.disable(b.BLEND),a.useShader("basic"),j.matrixLocation||(j.matrixLocation=b.getUniformLocation(j.program,"modelview_projection"),j.texture0Location=b.getUniformLocation(j.program,"texture0"),j.colorLocation=b.getUniformLocation(j.program,"color"),j.positionLocation=b.getAttribLocation(j.program,"a_position"),j.texcoord0Location=b.getAttribLocation(j.program,"a_texcoord0"),b.enableVertexAttribArray(j.positionLocation),b.enableVertexAttribArray(j.texcoord0Location)),c[0]=e+Math.cos(d)*g,c[1]=f+Math.sin(d)*g,c[4]=e+Math.cos(d+Math.PI)*g,c[5]=f+Math.sin(d+Math.PI)*g,c[8]=c[4]+Math.cos(d-Math.PI/4*3)*g/3*2*Math.lerp(.7,1,Math.random()),c[9]=c[5]+Math.sin(d-Math.PI/4*3)*g/3*2*Math.lerp(.7,1,Math.random()),b.bindBuffer(b.ARRAY_BUFFER,this.buffer),b.bufferData(b.ARRAY_BUFFER,c,b.DYNAMIC_DRAW),b.uniformMatrix4fv(j.matrixLocation,!1,a.projection),b.uniform4f(j.colorLocation,1,90/255,48/255,1),b.uniform1i(j.texture0Location,0),b.vertexAttribPointer(j.positionLocation,2,b.FLOAT,!1,16,0),b.vertexAttribPointer(j.texcoord0Location,2,b.FLOAT,!1,16,8),b.drawArrays(b.TRIANGLES,0,3)}});n.GliderScore=s,n.GliderReset=q,n.GliderInput=p,n.GliderMove=r,n.GliderRender=t,n.makeGlider=function(a){return a=a||m.GameObject.create(),a.add(p.create({87:"up",38:"up",32:"up"})),a.add(r.create()),a.add(t.create()),a}})}(this,this.load),function(a,b){var c=a.aqua,d=a.glider,e=c.type(c.Component,{onadd:function(a){this.world=a,this.particle=c.Particle.create([0,0,0],20,1),this.particle.isTrigger=!0,this.particle.on("collision",this.oncollision.bind(this)),this.world.addParticle(this.particle),this.x=this.world.box.left+this.world.box.width/4*3},oncollision:function(a,b){a.acceleration[1]+=4e3},fixedUpdate:function(){this.x<this.world.box.left&&(this.x=this.world.box.right),this.particle.position[0]=this.world.box.left+320}});d.Jet=e}(this,this.load)